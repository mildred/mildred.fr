<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Mildred&#39;s Website  | Configuring Cyrus IMAP</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.52" />

    
    <link rel="stylesheet" href="/style.css" />

    
      
    

    
  </head>

  <body>

    <header>
  <h1>Mildred&#39;s Website</h1>
  <h2>Configuring Cyrus IMAP</h2>
</header>
    <nav>
      <ul>
      
      
        <li><a
          class=""
          href="/"
          title="">Accueil</a></li>
      
        <li><a
          class=""
          href="/en/"
          title="">Home</a></li>
      
        <li><a
          class=""
          href="/curriculum-vitae/"
          title="">Curriculum Vitæ</a></li>
      
        <li><a
          class=""
          href="/contact/"
          title="">Contact</a></li>
      
      </ul>
    </nav>


<div class="left">
  <img alt="" class="photo" src="/Images/IMG_5669_square_128.jpeg">
  <img alt="" class="photo" src="/Images/ident-photo-2-128.jpeg">
  <img alt="" class="photo" src="/Images/all128.jpeg">

  

</div>

    <main>
      
<article>
  <h1>
    <a href="/en/articles/2020-11-05-configuring-cyrus-imap/">
      Configuring Cyrus IMAP
    </a>
  </h1>
  <div>
    

<p>I decided to install Cyrus IMAP on a server and create a terraform recipe for
automatic configuration management for this installation. My goal is to have an
easily maintainable mail server, and I choose Cyrus IMAP because it is pioneer
in many modern features such as JMAP. It&rsquo;s quite feature complete too.</p>

<p>The problem I got was user management. I don&rsquo;t plan to use Docker but I wanted
to be able to have a web interface for user management, without sharing a db
file on the disk (what if the user management and cyrus are on different
servers?) or share a database schema (what if I want to change the database
schema, should I modify the complete infrastructure because of it. What if I
change the database provider?).</p>

<p>Cyrus IMAP relies on Cyrus SASL for user management. It works with two different
options:</p>

<ul>
<li>auxprops, built-in with Cyrus SASL or pluggable using a shared library (<code>.so</code>)</li>
<li>authdaemon, externalized to a separate process but without much more choices
of providers and only supporting logins with plain password (no hashing
possible)</li>
</ul>

<p>And with auxprops, without writing a plugin, the choice is quite limited:</p>

<ul>
<li>LDAP server</li>
<li>NTLM, a Windows thing</li>
<li>OTP, I suppose one time passwords, not suitable for standard passwords</li>
<li>specific database file, not suitable for a networked infrastructure</li>
<li>SQL, not suitable if we want to keep the database schema private or if we
prefer SQLite (problem in a networked environment)</li>
<li>Kerebos, also a very specific authentication method</li>
</ul>

<p>After quite some thought, I decided to go with LDAP. It&rsquo;s quite a complex beast
but there are alternative to OpenLDAP. In particular, I found <a href="https://github.com/glauth/glauth">glauth</a> that
provides a minimal LDAP server written in Go just for authentication. If needed,
it will be easily extensible to allow authenticating with extra sources.</p>

<p>Now, the question is how to configure Cyrus to work with glauth&hellip;.</p>

<h2 id="step-1-make-cyrus-work-and-get-some-logs">Step 1: Make Cyrus work and get some logs</h2>

<p>To make things worse, I decided to use configuration file in a non standard
location, to avoid messing with the distribution packages that I otherwise use
(so I can get security updates easily). My configuration files are in
<code>/etc/cyrus/cyrus.conf</code> and <code>/etc/cyrus/imapd.conf</code> instead of <code>/etc/cyrus.conf</code>
and <code>/etc/imapd.conf</code>.</p>

<p>Cyrus works by having a master process (configured with the <code>cyrus.conf</code> file)
that handle listening to sockets and spawning separate daemons for each
protocol. The first problem was that the daemons were taking the configuration
in <code>/etc/imapd.conf</code> instead of <code>/etc/cyrus/imapd.conf</code> and I was not able to
get extra logging.</p>

<p>The solution is to specify the configuration file location in <code>cyrus.conf</code> for
each and every daemon using the <code>-C</code> option 9that is otherwise missing from that
file):</p>

<pre><code>START {
	# do not delete this entry!
	recover		cmd=&quot;/usr/sbin/cyrus ctl_cyrusdb -C /etc/cyrus/imapd.conf -r&quot;
	...
}

SERVICES {
	imap		cmd=&quot;imapd -C /etc/cyrus/imapd.conf -U 30&quot; listen=&quot;imap&quot; prefork=0 maxchild=1
	...
}

EVENTS {
	# this is required
	checkpoint	cmd=&quot;/usr/sbin/cyrus ctl_cyrusdb -C /etc/cyrus/imapd.conf -c&quot; period=30
	...
}
</code></pre>

<p>I also modified the <code>maxchild=</code> option from 100 to 1 for <code>imapd</code> for easier
process tracing, we&rsquo;ll see that later on.</p>

<p>I also enable debug logging in <code>/etc/cyrus/imapd.conf</code>:</p>

<pre><code>debug: 1

# SASL_LOG_NONE  0 don't log anything
# SASL_LOG_ERR   1 log unusual errors (default)
# SASL_LOG_FAIL  2 log all authentication failures
# SASL_LOG_WARN  3 log non-fatal warnings
# SASL_LOG_NOTE  4 more verbose than LOG_WARN
# SASL_LOG_DEBUG 5 more verbose than LOG_NOTE
# SASL_LOG_TRACE 6 traces of internal protocols
# SASL_LOG_PASS  7 traces of internal protocols, including passwords
sasl_log_level: 7
</code></pre>

<h2 id="step-2-basic-configuration-and-authentication-testing">Step 2: basic configuration and authentication testing</h2>

<p>In <code>imapd.conf</code> I also configured the basic settings for authentication:</p>

<pre><code>allowplaintext: yes
sasl_pwcheck_method: auxprop
sasl_auto_transition: yes
sasl_auxprop_plugin: ldapdb
</code></pre>

<p>And started testing with the following command on the server:</p>

<pre><code>cyrus imtest -u jdoe@example.com -w dogood
</code></pre>

<p>I enabled the logs on cyrus and glauth and plan to improve on to get something
working. For now, I get the following logs from Cyrus:</p>

<pre><code>cyrus/master[12535]: about to exec /usr/lib/cyrus/bin/imapd
cyrus/imap[12535]: executed
cyrus/imap[12535]: ldapdb
cyrus/imap[12535]: _sasl_plugin_load failed on sasl_canonuser_init
cyrus/imap[12535]: auxpropfunc error invalid parameter supplied
cyrus/imap[12535]: _sasl_plugin_load failed on sasl_auxprop_plug_init
cyrus/imap[12535]: ldapdb
cyrus/imap[12535]: _sasl_plugin_load failed on sasl_canonuser_init
cyrus/imap[12535]: accepted connection
cyrus/imap[12535]: SASL DIGEST-MD5 server step 1
cyrus/imap[12535]: SASL DIGEST-MD5 server step 2
cyrus/imap[12535]: SASL could not find auxprop plugin, was searching for 'ldapdb
cyrus/imap[12535]: SASL unable to canonify user and get auxprops&quot;+y
cyrus/imap[12535]: SASL DIGEST-MD5 common mech dispose
cyrus/imap[12535]: badlogin: localhost [::1] DIGEST-MD5 [SASL(-4): no mechanism available: unable to canonify user and get auxprops]
</code></pre>

<p>I don&rsquo;t get what does not work, the error messages are not very specific. Let&rsquo;s
debug this&hellip;</p>

<h2 id="step-3-debug-the-whole-thing-and-understand-what-s-missing">Step 3: Debug the whole thing and understand what&rsquo;s missing</h2>

<p><code>ltrace</code> or <code>strace</code> did not help very much, so I resolved to debug with gdb. I
<a href="https://wiki.debian.org/HowToGetABacktrace">installed the debug packages</a> <code>libsasl2-2-dbgsym</code>,
<code>libsasl2-modules-dbgsym</code>, <code>libsasl2-modules-db-dbgsym</code> and
<code>libsasl2-modules-ldap-dbgsym</code> and started gdb:</p>

<pre><code>gdb -p $(pidof master)
...
(gdb) set follow-fork-mode child
</code></pre>

<p>I found that the message <code>_sasl_plugin_load failed on sasl_auxprop_plug_init</code>
came from the function <code>sasl_canonuser_add_plugin</code>, so I set a breakpoint on it:</p>

<pre><code>(gdb) break sasl_canonuser_add_plugin
Function &quot;sasl_canonuser_add_plugin&quot; not defined.
Make breakpoint pending on future shared library load? (y or [n]) y
Breakpoint 1 (sasl_canonuser_add_plugin) pending.
(gdb) c
</code></pre>

<p>Now, gdb is ready to catch the issue, I started <code>cyrus imtest</code> as above and got
to debug it:</p>

<pre><code>Thread 2.1 &quot;imapd&quot; hit Breakpoint 1, sasl_canonuser_add_plugin (plugname=plugname@entry=0x7f6bc4a231cd &quot;INTERNAL&quot;, 
    canonuserfunc=0x7f6bc4a139e0 &lt;internal_canonuser_init&gt;) at ../../lib/canonusr.c:308
308 ../../lib/canonusr.c: No such file or directory.
(gdb) c
</code></pre>

<p>This first breakpoint was for a plugin named <code>&quot;INTERNAL&quot;</code>, not my problem so I
continued&hellip;</p>

<pre><code>Thread 2.1 &quot;imapd&quot; hit Breakpoint 1, sasl_canonuser_add_plugin (plugname=plugname@entry=0x7ffd87fed980 &quot;ldapdb&quot;, canonuserfunc=0x7f6bc16b7450 &lt;sasl_canonuser_init&gt;)
    at ../../lib/canonusr.c:308
308 in ../../lib/canonusr.c
</code></pre>

<p>There, my plugin&hellip; The <code>disas</code> command will get you the disassembled code for
that function. I didn&rsquo;t know I knew how to read assembler code but that&rsquo;s not so
hard to understand:</p>

<pre><code>=&gt; 0x00007f6bc4a13870 &lt;+0&gt;:	push   %r12
   0x00007f6bc4a13872 &lt;+2&gt;:	push   %rbp
   0x00007f6bc4a13873 &lt;+3&gt;:	push   %rbx
   0x00007f6bc4a13874 &lt;+4&gt;:	sub    $0x20,%rsp
   0x00007f6bc4a13878 &lt;+8&gt;:	mov    %fs:0x28,%rax
   0x00007f6bc4a13881 &lt;+17&gt;:	mov    %rax,0x18(%rsp)
   0x00007f6bc4a13886 &lt;+22&gt;:	xor    %eax,%eax
   0x00007f6bc4a13888 &lt;+24&gt;:	test   %rdi,%rdi
   0x00007f6bc4a1388b &lt;+27&gt;:	je     0x7f6bc4a139a8 &lt;sasl_canonuser_add_plugin+312&gt;
   0x00007f6bc4a13891 &lt;+33&gt;:	mov    %rdi,%rbx
   0x00007f6bc4a13894 &lt;+36&gt;:	mov    %rsi,%rbp
   0x00007f6bc4a13897 &lt;+39&gt;:	callq  0x7f6bc4a11130 &lt;strlen@plt&gt;
   0x00007f6bc4a1389c &lt;+44&gt;:	cmp    $0xfff,%rax
   0x00007f6bc4a138a2 &lt;+50&gt;:	ja     0x7f6bc4a139a8 &lt;sasl_canonuser_add_plugin+312&gt;
   0x00007f6bc4a138a8 &lt;+56&gt;:	mov    0x16689(%rip),%rax        # 0x7f6bc4a29f38
   0x00007f6bc4a138af &lt;+63&gt;:	lea    0x10(%rsp),%rcx
   0x00007f6bc4a138b4 &lt;+68&gt;:	lea    0xc(%rsp),%rdx
   0x00007f6bc4a138b9 &lt;+73&gt;:	mov    %rbx,%r8
   0x00007f6bc4a138bc &lt;+76&gt;:	mov    $0x5,%esi
   0x00007f6bc4a138c1 &lt;+81&gt;:	mov    (%rax),%rdi
   0x00007f6bc4a138c4 &lt;+84&gt;:	callq  *%rbp
   0x00007f6bc4a138c6 &lt;+86&gt;:	mov    %eax,%r12d
   0x00007f6bc4a138c9 &lt;+89&gt;:	test   %eax,%eax
   0x00007f6bc4a138cb &lt;+91&gt;:	jne    0x7f6bc4a13988 &lt;sasl_canonuser_add_plugin+280&gt;
</code></pre>

<p>The equivalent C code on GitHub to better understand what it means:</p>

<pre><code class="language-c">int sasl_canonuser_add_plugin(const char *plugname,
			      sasl_canonuser_init_t *canonuserfunc) 
{
    int result, out_version;
    canonuser_plug_list_t *new_item;
    sasl_canonuser_plug_t *plug;

    if(!plugname || strlen(plugname) &gt; (PATH_MAX - 1)) {
	sasl_seterror(NULL, 0,
		      &quot;bad plugname passed to sasl_canonuser_add_plugin\n&quot;);
	return SASL_BADPARAM;
    }
    
    result = canonuserfunc(sasl_global_utils, SASL_CANONUSER_PLUG_VERSION,
			   &amp;out_version, &amp;plug, plugname);

    if(result != SASL_OK) {
	_sasl_log(NULL, SASL_LOG_ERR, &quot;%s_canonuser_plug_init() failed in sasl_canonuser_add_plugin(): %z\n&quot;,
		  plugname, result);
	return result;
    }
    ...
}
</code></pre>

<p>Using <code>nexti</code> to jump each time to the next instruction, I found that the issue
was the <code>canonuserfunc</code> returned an error. I had jumped too far so I resumed a
new debug session and this time, I jumped into the indirect call <code>callq  *%rbp</code>
using <code>stepi</code> a few times to get to the plugin function. Dynamic loading the
plugin generates a few trampoline functions that I had to stop through.</p>

<p>I got into the <code>ldapdb_canonuser_plug_init</code> function:</p>

<pre><code>(gdb) si
ldapdb_canonuser_plug_init (utils=0x55adbb27ef50, max_version=5, out_version=0x7ffd87fec8dc, plug=0x7ffd87fec8e0, plugname=0x7ffd87fed980 &quot;ldapdb&quot;)
    at ../../plugins/ldapdb.c:565
565 ../../plugins/ldapdb.c: No such file or directory.
(gdb) disas
Dump of assembler code for function ldapdb_canonuser_plug_init:
=&gt; 0x00007f6bc16b73e0 &lt;+0&gt;: test   %rdx,%rdx
   0x00007f6bc16b73e3 &lt;+3&gt;: je     0x7f6bc16b7430 &lt;ldapdb_canonuser_plug_init+80&gt;
   0x00007f6bc16b73e5 &lt;+5&gt;: test   %rcx,%rcx
   0x00007f6bc16b73e8 &lt;+8&gt;: je     0x7f6bc16b7430 &lt;ldapdb_canonuser_plug_init+80&gt;
   0x00007f6bc16b73ea &lt;+10&gt;:    cmp    $0x4,%esi
   0x00007f6bc16b73ed &lt;+13&gt;:    jle    0x7f6bc16b7420 &lt;ldapdb_canonuser_plug_init+64&gt;
   0x00007f6bc16b73ef &lt;+15&gt;:    push   %rbp
   0x00007f6bc16b73f0 &lt;+16&gt;:    mov    %rcx,%rbp
   0x00007f6bc16b73f3 &lt;+19&gt;:    push   %rbx
   0x00007f6bc16b73f4 &lt;+20&gt;:    mov    %rdx,%rbx
   0x00007f6bc16b73f7 &lt;+23&gt;:    sub    $0x8,%rsp
   0x00007f6bc16b73fb &lt;+27&gt;:    callq  0x7f6bc16b6d00 &lt;ldapdb_config&gt;
   0x00007f6bc16b7400 &lt;+32&gt;:    movl   $0x5,(%rbx)
   0x00007f6bc16b7406 &lt;+38&gt;:    lea    0x3c13(%rip),%rbx        # 0x7f6bc16bb020 &lt;ldapdb_canonuser_plugin&gt;
   0x00007f6bc16b740d &lt;+45&gt;:    mov    %rbx,0x0(%rbp)
   0x00007f6bc16b7411 &lt;+49&gt;:    add    $0x8,%rsp
   0x00007f6bc16b7415 &lt;+53&gt;:    pop    %rbx
   0x00007f6bc16b7416 &lt;+54&gt;:    pop    %rbp
   0x00007f6bc16b7417 &lt;+55&gt;:    retq   
   0x00007f6bc16b7418 &lt;+56&gt;:    nopl   0x0(%rax,%rax,1)
   0x00007f6bc16b7420 &lt;+64&gt;:    mov    $0xffffffe9,%eax
   0x00007f6bc16b7425 &lt;+69&gt;:    retq   
   0x00007f6bc16b7426 &lt;+70&gt;:    nopw   %cs:0x0(%rax,%rax,1)
   0x00007f6bc16b7430 &lt;+80&gt;:    mov    $0xfffffff9,%eax
   0x00007f6bc16b7435 &lt;+85&gt;:    retq   
End of assembler dump.
(gdb) bt
#0  ldapdb_canonuser_plug_init (utils=0x55adbb27ef50, max_version=5, out_version=0x7ffd87fec8dc, plug=0x7ffd87fec8e0, plugname=0x7ffd87fed980 &quot;ldapdb&quot;)
    at ../../plugins/ldapdb.c:565
#1  0x00007f6bc4a138c6 in sasl_canonuser_add_plugin (plugname=plugname@entry=0x7ffd87fed980 &quot;ldapdb&quot;, canonuserfunc=0x7f6bc16b7450 &lt;sasl_canonuser_init&gt;)
    at ../../lib/canonusr.c:319
...
</code></pre>

<p>The equivalent C code:</p>

<pre><code class="language-c">int ldapdb_canonuser_plug_init(const sasl_utils_t *utils,
                             int max_version,
                             int *out_version,
                             sasl_canonuser_plug_t **plug,
                             const char *plugname __attribute__((unused))) 
{
    int rc;

    if(!out_version || !plug) return SASL_BADPARAM;

    if(max_version &lt; SASL_CANONUSER_PLUG_VERSION) return SASL_BADVERS;
    
    rc = ldapdb_config(utils);

    *out_version = SASL_CANONUSER_PLUG_VERSION;

    *plug = &amp;ldapdb_canonuser_plugin;

    return rc;
}
</code></pre>

<p>Here, the problem is with <code>ldapdb_config(utils)</code> that returns an error.
Continuing into that function, I got the following code:</p>

<pre><code class="language-c">    utils-&gt;getopt(utils-&gt;getopt_context, ldapdb, &quot;ldapdb_uri&quot;, &amp;p-&gt;uri, NULL);
    if(!p-&gt;uri) return SASL_BADPARAM;
</code></pre>

<p>I had forgotten the <code>ldapdb_uri</code> configuration parameter (of course, I&rsquo;m just
testing and I had disabled the line in hope to get a meaningful error).</p>

<h2 id="step-4-basic-sasl-configuration">Step 4: Basic SASL configuration</h2>

<p>Let&rsquo;s configure it in <code>imapd.conf</code> using random values from the
<a href="http://www.cyrusimap.org/sasl/sasl/options.html#examples">documentation</a>:</p>

<pre><code>allowplaintext: yes
sasl_pwcheck_method: auxprop
sasl_auto_transition: yes
sasl_auxprop_plugin: ldapdb

sasl_ldapdb_uri: ldap://glauth/dc=users,dc=local/
sasl_ldapdb_id: cyrus
sasl_ldapdb_pw: cyrus
sasl_ldapdb_mech: PLAIN
sasl_ldapdb_canon_attr: mail
</code></pre>

<p>It should work because I have the following request that is working:</p>

<pre><code>$ ldapsearch -h glauth -p 3893 -D cn=cyrus,ou=machines,dc=users,dc=local -b dc=users,dc=local -w cyrus mail=jdoe@example.com

dn: cn=johndoe,ou=superheros,dc=users,dc=local
# ...
# numResponses: 2
# numEntries: 1
</code></pre>

<p>Note the use of the <code>sasl_ldabdb_</code> option prefix instead of just <code>ldap_</code> as
appears in the <code>imapd.conf</code> man page. <code>sasl_*</code> options are all passed verbatim
to Cyrus SASL.</p>

<p>I got a little further, but there is still work to do. No more errors from the
plugin though:</p>

<pre><code>cyrus/master[13555]: about to exec /usr/lib/cyrus/bin/imapd
cyrus/imap[13555]: executed
cyrus/imap[13555]: accepted connection
cyrus/imap[13555]: SASL DIGEST-MD5 server step 1
cyrus/imap[13555]: SASL DIGEST-MD5 server step 2
cyrus/imap[13555]: SASL unable to canonify user and get auxprops
cyrus/imap[13555]: SASL DIGEST-MD5 common mech dispose
cyrus/imap[13555]: badlogin: localhost [::1] DIGEST-MD5 [SASL(-1): generic failure: unable to canonify user and get auxprops]
</code></pre>

<h2 id="step-5-more-debugging">Step 5: More debugging</h2>

<p>Let&rsquo;s enable back <code>maxprocs=1</code> in <code>cyrus.conf</code> and restart the master process.</p>

<pre><code># gdb -p $(pidof master) -ex 'set follow-fork-mode child'
(gdb) break ldapdb_canonuser_plug_init
(gdb) c
...
(gdb) si
...
(gdb) ni
475 in ../../plugins/ldapdb.c
(gdb) print p-&gt;uri
$1 = 0x558a24684ce0 &quot;ldap://glauth/dc=users,dc=local/&quot;
</code></pre>

<p>No problem with the configuration this time&hellip; Let&rsquo;s break somewhere else.</p>

<pre><code>(gdb) break ldapdb_canon_client
Breakpoint 2 at 0x7ff322b66f40: ldapdb_canon_client. (2 locations)
(gdb) break ldapdb_canon_server
Breakpoint 3 at 0x7ff322b67010: ldapdb_canon_server. (2 locations)
(gdb) c
</code></pre>

<p>No match&hellip; let&rsquo;s try:</p>

<pre><code>(gdb) break ldapdb_connect
...
Thread 2.1 &quot;imapd&quot; hit Breakpoint 1, ldapdb_connect (ctx=ctx@entry=0x7f08784ba0e0 &lt;ldapdb_ctx&gt;, user=user@entry=0x565338fa59e1 &quot;root&quot;, ulen=ulen@entry=4, 
    cp=cp@entry=0x7ffdb182ea80, sparams=&lt;optimized out&gt;) at ../../plugins/ldapdb.c:81
81  ../../plugins/ldapdb.c: No such file or directory.
(gdb) print ctx-&gt;uri
$1 = 0x565338f9cce0 &quot;ldap://glauth/dc=users,dc=local/&quot;
(gdb) print cp-&gt;ld
$2 = (LDAP *) 0x0
</code></pre>

<p>Got it, the code:</p>

<pre><code class="language-c">static int ldapdb_connect(ldapctx *ctx, sasl_server_params_t *sparams,
	const char *user, unsigned ulen, connparm *cp)
{
    int i, rc;
    char *authzid;

    if((i=ldap_initialize(&amp;cp-&gt;ld, ctx-&gt;uri))) {
	cp-&gt;ld = NULL;
	return i;
    }
</code></pre>

<p>And we have <code>ldap_initialize</code> that returns with <code>-9</code>, that&rsquo;s <code>LDAP_PARAM_ERROR</code>
as shown in <a href="https://github.com/delphij/openldap/blob/master/include/ldap.h#L713"><code>ldap.h</code></a>.
Ok, the URI I specified is not correct&hellip;</p>

<p>After getting <a href="https://libldap.readthedocs.io/en/latest/libldap.html#libldap.ldap_initialize">some more doc</a>,
I rewrite the <code>imapd.conf</code> options to:</p>

<pre><code>sasl_ldapdb_uri: ldap://glauth/dc=users,dc=local
sasl_ldapdb_id: cn=cyrus,ou=machines
sasl_ldapdb_pw: cyrus
sasl_ldapdb_mech: PLAIN
sasl_ldapdb_canon_attr: mail
</code></pre>

<p>What prompted me to change the <code>sasl_ldapdb_id</code> is the documentation:</p>

<blockquote>
<p>LDAP URI (Uniform Resource Identifier). It has the following form:
<code>ldap[is]://host[:port][/dn]</code>. This parameter is identical to that of the
underlying function ldap_initialize() of the library openLDAP except the
optional dn. When this dn is provided, each parameter of a method of an
instance of a LDAPObject which is a DN, is automatically completed by dn
unless it already ends with dn. For example, in the code below:</p>

<pre><code>&gt;&gt;&gt; l = ldap_initialize('ldap:://host.test/dc=example,dc=test')
&gt;&gt;&gt; l.simple_bind_s(user='cn=admin', password='secret')
</code></pre>

<p>parameter user is rewritten to ‘<code>cn=admin,dc=example,dc=test</code>’ before passed
to the underlying OpenLDAP library C function</p>
</blockquote>

<p>No more luck, I get the exact same <code>LDAP_PARAM_ERROR</code>.</p>

<p>Let&rsquo;s dig into ldap itself&hellip;</p>

<pre><code>(gdb) break ldap_initialize
    Thread 2.1 &quot;imapd&quot; hit Breakpoint 1, ldap_initialize (ldp=ldp@entry=0x7ffe3566d780, url=0x558ea5417c30 &quot;ldap://glauth/dc=users,dc=local&quot;) at open.c:235
235 open.c: No such file or directory.
</code></pre>

<p>In <a href="https://github.com/openldap/openldap/blob/OPENLDAP_REL_ENG_2_4_47/libraries/libldap/open.c#L235"><code>ldap_initialize</code></a>
its&rsquo;s <code>ldap_set_option</code> that returns the error. In this function there is this
interesting piece of code:</p>

<pre><code class="language-c">			case LDAP_URL_ERR_PARAM:	/* parameter is bad */
			case LDAP_URL_ERR_BADSCHEME:	/* URL doesn't begin with &quot;ldap[si]://&quot; */
			case LDAP_URL_ERR_BADENCLOSURE:	/* URL is missing trailing &quot;&gt;&quot; */
			case LDAP_URL_ERR_BADURL:	/* URL is bad */
			case LDAP_URL_ERR_BADHOST:	/* host port is bad */
			case LDAP_URL_ERR_BADATTRS:	/* bad (or missing) attributes */
			case LDAP_URL_ERR_BADSCOPE:	/* scope string is invalid (or missing) */
			case LDAP_URL_ERR_BADFILTER:	/* bad or missing filter */
			case LDAP_URL_ERR_BADEXTS:	/* bad or missing extensions */
				rc = LDAP_PARAM_ERROR;
				break;
</code></pre>

<p>But before that, in <code>ldap_url_parselist_int</code>, we can see that the single url is
parsed into a list of two URLs:</p>

<pre><code>Thread 2.1 &quot;imapd&quot; hit Breakpoint 3, ldap_url_parselist_int (ludlist=ludlist@entry=0x7ffe3566d660, url=url@entry=0x558ea5417c30 &quot;ldap://glauth/dc=users,dc=local&quot;, 
    sep=sep@entry=0x0, flags=flags@entry=3) at url.c:1279

(gdb) print urls[0]
$5 = 0x558ea542e280 &quot;ldap://glauth/dc=users&quot;
(gdb) print urls[1]
$6 = 0x558ea542e1c0 &quot;dc=local&quot;
</code></pre>

<p>This time, let&rsquo;s try and escape the comma in the URL in <code>imapd.conf</code>:</p>

<pre><code>sasl_ldapdb_uri: ldap://glauth/dc=users%44dc=local
sasl_ldapdb_id: cn=cyrus,ou=machines
sasl_ldapdb_pw: cyrus
sasl_ldapdb_mech: PLAIN
sasl_ldapdb_canon_attr: mail
</code></pre>

<p>This time, <code>ldap_url_parselist_int</code> and <code>ldapdb_connect</code> succeeds&hellip; Back to
Cyrus SASL.</p>

<p>In <code>ldapdb_connect</code>, the function still returns with <code>-1</code> (where 0 is probably
the success code) because of <code>ldap_sasl_interactive_bind_s</code>. I needed to get the
debian version of
<a href="https://sources.debian.org/src/openldap/2.4.47+dfsg-3+deb10u3/libraries/libldap/cyrus.c/#L358"><code>cyrus.c</code></a>
to get the correct line numbers.</p>

<pre><code class="language-c">		if ( sd == AC_SOCKET_INVALID || !ld-&gt;ld_defconn ) {
			/* not connected yet */

			rc = ldap_open_defconn( ld );

			if ( rc == 0 ) {
</code></pre>

<p><code>ldap_open_defconn</code> returned <code>rc</code> with <code>-1</code>.</p>

<p>To get more debug messages, I manually changed the log level with gdb:</p>

<pre><code>(gdb) print (&amp;ldap_int_global_options)-&gt;ldo_debug
$16 = 255
(gdb) set var (&amp;ldap_int_global_options)-&gt;ldo_debug = 0xFFFFFFFF
(gdb) print (&amp;ldap_int_global_options)-&gt;ldo_debug
$17 = -1
</code></pre>

<p>And I got a lot of log messages with the <code>imtest</code> program:</p>

<pre><code>S: ldap_create
base64 decoding error
Authentication failed. generic failure
Security strength factor: 128
C: C01 CAPABILITY
S: ldap_url_parse_ext(ldap://glauth/dc=users%44dc=local)
S: ldap_sasl_interactive_bind: user selected: PLAIN
S: ldap_int_sasl_bind: PLAIN
S: ldap_new_connection 1 1 0
S: ldap_int_open_connection
S: ldap_connect_to_host: TCP glauth:389
S: ldap_new_socket: 15
S: ldap_prepare_socket: 15
S: ldap_connect_to_host: Trying fd5c:4791:2773:2b8:8000::2 389
S: ldap_pvt_connect: fd: 15 tm: -1 async: 0
S: attempting to connect: 
S: connect errno: 111
S: ldap_close_socket: 15
S: ldap_new_socket: 15
S: ldap_prepare_socket: 15
S: ldap_connect_to_host: Trying 127.0.0.2:389
S: ldap_pvt_connect: fd: 15 tm: -1 async: 0
S: attempting to connect: 
S: connect errno: 111
S: ldap_close_socket: 15
S: ldap_msgfree
S: A01 NO remote authentication server unavailable
</code></pre>

<p>glauth is not listening on port 389 but on port 3893. This time I found a way to
get way more info. For the meantime, let&rsquo;s change the LDAP port number on the
configuration.</p>

<h2 id="step-6-failing-to-make-cyrus-authenticate-to-glauth-ldap-server">Step 6: Failing to make Cyrus authenticate to glauth LDAP server</h2>

<p>This time, the error log on the server is:</p>

<pre><code>Nov 05 14:51:19 vps-e7887199 cyrus/master[16395]: about to exec /usr/lib/cyrus/bin/imapd
Nov 05 14:51:19 vps-e7887199 cyrus/imap[16395]: executed
Nov 05 14:51:19 vps-e7887199 cyrus/imap[16395]: accepted connection
Nov 05 14:51:19 vps-e7887199 cyrus/imap[16395]: SASL DIGEST-MD5 server step 1
Nov 05 14:51:19 vps-e7887199 cyrus/imap[16395]: SASL DIGEST-MD5 server step 2
Nov 05 14:51:19 vps-e7887199 cyrus/imap[16395]: SASL No worthy mechs found
Nov 05 14:51:19 vps-e7887199 cyrus/imap[16395]: SASL unable to canonify user and get auxprops
Nov 05 14:51:19 vps-e7887199 cyrus/imap[16395]: SASL DIGEST-MD5 common mech dispose
Nov 05 14:51:19 vps-e7887199 cyrus/imap[16395]: badlogin: localhost [::1] DIGEST-MD5 [SASL(-1): generic failure: unable to canonify user and get auxprops]
</code></pre>

<p>After restarting cyrus, I start gdb, run a test (<code>imtest</code>), Ctrl-C to break gdb
and update log level:</p>

<pre><code># gdb -p $(pidof master) -ex 'set follow-fork-mode child'
(gdb) c

...

Thread 2.1 &quot;imapd&quot; received signal SIGINT, Interrupt.
(gdb) set var (&amp;ldap_int_global_options)-&gt;ldo_debug = -1
(gdb) print (&amp;ldap_int_global_options)-&gt;ldo_debug
$1 = -1
(gdb) c
</code></pre>

<p>The logs from OpenLDAP:</p>

<pre><code>S: ldap_url_parse_ext(ldap://glauth:3893/dc=users%44dc=local)
S: ldap_sasl_interactive_bind: user selected: PLAIN
S: ldap_int_sasl_bind: PLAIN
S: ldap_new_connection 1 1 0
S: ldap_int_open_connection
S: ldap_connect_to_host: TCP glauth:3893
S: ldap_new_socket: 15
S: ldap_prepare_socket: 15
S: ldap_connect_to_host: Trying fd5c:4791:2773:2b8:8000::2 3893
S: ldap_pvt_connect: fd: 15 tm: -1 async: 0
S: attempting to connect: 
S: connect errno: 111
S: ldap_close_socket: 15
S: ldap_new_socket: 15
S: ldap_prepare_socket: 15
S: ldap_connect_to_host: Trying 127.0.0.2:3893
S: ldap_pvt_connect: fd: 15 tm: -1 async: 0
S: attempting to connect: 
S: connect success
S: ldap_int_sasl_open: host=glauth
S: ldap_msgfree
S: ldap_free_connection 1 1
S: ldap_send_unbind
S: ldap_free_connection: actually freed
S: A01 NO generic failure
</code></pre>

<p>Trying to decode the LDAP protocol with <code>tcpdump -nvvv -i lo 'port 3893'</code> but
protocol decode is not powerful enough to understand what&rsquo;s going on. Nothing
seems bad on the LDAP client side, the only error to continue debugging is:</p>

<blockquote>
<p>SASL No worthy mechs found</p>
</blockquote>

<p>Could it be Cyrus that fails to authenticate to glauth because there is no
matching login mechanism ? let&rsquo;s try removing the <code>sasl_ldapdb_mech: PLAIN</code>
configuration line&hellip;</p>

<p>This time, glauth is outputting some more information (the force-bind lines
below):</p>

<pre><code>cyrus/master[17012]: about to exec /usr/lib/cyrus/bin/imapd
cyrus/imap[17012]: executed
cyrus/imap[17012]: accepted connection
cyrus/imap[17012]: SASL DIGEST-MD5 server step 1
cyrus/imap[17012]: SASL DIGEST-MD5 server step 2
force-bind[12757]: 15:09:13.295780 Search ▶ DEBU 014 Search request as  from 127.0.0.1:56398 for (objectclass=*)
force-bind[12757]: 2020/11/05 15:09:13 handleSearchRequest error LDAP Result Code 50 &quot;Insufficient Access Rights&quot;: Search Error: Anonymous BindDN not allowed
cyrus/imap[17012]: SASL unable to canonify user and get auxprops
cyrus/imap[17012]: SASL DIGEST-MD5 common mech dispose
cyrus/imap[17012]: badlogin: localhost [::1] DIGEST-MD5 [SASL(-13): authentication failure: unable to canonify user and get auxprops]
</code></pre>

<p>This time, the request makes its way to glauth. The message <code>Search Error:
Anonymous BindDN not allowed</code> signifies that the bind request was made with an
empty bind dn (<code>-D</code> option in <code>ldapsearch</code>). In our case, the bind dn should be
<code>dc=users,dc=local</code> and we have to configure Cyrus SASL to this.</p>

<p>Reading <a href="https://serverfault.com/questions/616698/in-ldap-what-exactly-is-a-bind-dn">on the topic on
ServerFault</a>
I could grab that the bind dn was sort of like your user id and it should not be
empty.</p>

<p>I discovered that the bind dn was always empty on Cyrus SASL in <a href="https://github.com/cyrusimap/cyrus-sasl/blob/cyrus-sasl-2.1.27/plugins/ldapdb.c#L117"><code>ldabdb.c</code></a>:</p>

<pre><code class="language-c">    i = ldap_sasl_interactive_bind_s(cp-&gt;ld, NULL, ctx-&gt;mech.bv_val, NULL,
    	NULL, LDAP_SASL_QUIET, ldapdb_interact, ctx);
    if (i != LDAP_SUCCESS) {
    	sparams-&gt;utils-&gt;free(authzid);
	return i;
    }
</code></pre>

<p>The second parameter set to <code>NULL</code> is the bind db as evidenced <a href="https://github.com/cyrusimap/cyrus-sasl/blob/cyrus-sasl-2.1.27/saslauthd/lak.c#L1081-L1089">elsewhere in the
code</a>.
The solution is to either <a href="https://github.com/cyrusimap/cyrus-sasl/issues/629">change Cyrus SASL to allow the bind dn to be
configurable</a> or <a href="https://github.com/glauth/glauth/issues/83">change
glauth to allow empty bind dn</a>.</p>

<h2 id="step-7-new-ldap-server-ldap-client-not-behaving">Step 7: New LDAP server, LDAP client not behaving</h2>

<p>After a custom build of the LDAP server, still, it does not work. There must be
something on the SASL client library that I don&rsquo;t understand. Both <code>ldapsearch</code>
and Cyrus SASL via <code>imtest</code> are failing.</p>

<p>Here is what I get with <code>ldapsearch</code> using a base dn:</p>

<pre><code>Bind ▶ DEBU 023  &quot;level&quot;=6 &quot;msg&quot;=&quot;Bind request&quot;  &quot;basedn&quot;=&quot;dc=users,dc=local&quot; &quot;binddn&quot;=&quot;cn=cyrus,ou=machines,dc=users,dc=local&quot; &quot;src&quot;={&quot;IP&quot;:&quot;127.0.0.1&quot;,&quot;Port&quot;:57894,&quot;Zone&quot;:&quot;&quot;}
Bind ▶ DEBU 024  &quot;level&quot;=6 &quot;msg&quot;=&quot;Bind success&quot;  &quot;binddn&quot;=&quot;cn=cyrus,ou=machines,dc=users,dc=local&quot; &quot;src&quot;={&quot;IP&quot;:&quot;127.0.0.1&quot;,&quot;Port&quot;:57894,&quot;Zone&quot;:&quot;&quot;}
Search ▶ DEBU 025  &quot;level&quot;=6 &quot;msg&quot;=&quot;{BaseDN:dc=users,dc=local Scope:2 DerefAliases:0 SizeLimit:0 TimeLimit:0 TypesOnly:false Filter:(mail=jdoe@example.com) Attributes:[] Controls:[]}\n&quot;
Search ▶ DEBU 026  &quot;level&quot;=6 &quot;msg&quot;=&quot;Search request&quot;  &quot;basedn&quot;=&quot;,dc=users,dc=local&quot; &quot;binddn&quot;=&quot;cn=cyrus,ou=machines,dc=users,dc=local&quot; &quot;filter&quot;=&quot;(mail=jdoe@example.com)&quot; &quot;src&quot;={&quot;IP&quot;:&quot;127.0.0.1&quot;,&quot;Port&quot;:57894,&quot;Zone&quot;:&quot;&quot;}
Search ▶ DEBU 027  &quot;level&quot;=6 &quot;msg&quot;=&quot;AP: Search OK&quot;  &quot;filter&quot;=&quot;(mail=jdoe@example.com)&quot;
</code></pre>

<p>Here is what I get without base dn and authentication on LDAP:</p>

<pre><code>Search ▶ DEBU 020  &quot;level&quot;=6 &quot;msg&quot;=&quot;{BaseDN: Scope:0 DerefAliases:0 SizeLimit:0 TimeLimit:0 TypesOnly:false Filter:(objectclass=*) Attributes:[supportedSASLMechanisms] Controls:[]}\n&quot;
Search ▶ DEBU 021  &quot;level&quot;=6 &quot;msg&quot;=&quot;Search request&quot;  &quot;basedn&quot;=&quot;,dc=users,dc=local&quot; &quot;binddn&quot;=&quot;&quot; &quot;filter&quot;=&quot;(objectclass=*)&quot; &quot;src&quot;={&quot;IP&quot;:&quot;127.0.0.1&quot;,&quot;Port&quot;:57874,&quot;Zone&quot;:&quot;&quot;}
Search ▶ DEBU 022  &quot;level&quot;=6 &quot;msg&quot;=&quot;AP: Search OK&quot;  &quot;filter&quot;=&quot;(objectclass=*)&quot;
</code></pre>

<p>The difference is in the search request, the filter is <code>(objectclass=*)</code> instead
of the user email <code>(mail=jdoe@example.com)</code>. The reason why the filter is not
transmitted when there is no authentication escapes to my reason for the moment.</p>

<h2 id="step-8-making-the-ldap-authentication-work">Step 8: Making the LDAP authentication work</h2>

<p>We&rsquo;re back to making authenticated LDAP work properly. After documenting myself,
I found that there are two ways to authenticate on LDAP: simple bind and SASL.
Probably Cyrus SASL is trying to use SASL to authenticate itself as Cyrus on
LDAP, and my LDAP server is only understanding simple bind.</p>

<p>SASL Bind operation is described in <a href="https://tools.ietf.org/html/rfc4513#section-5.2">RFC 4513 section 5.2</a></p>

<p>While looking up implementation, I found that
<a href="https://tools.ietf.org/html/rfc4512#section-5.1">RFC 4512 section 5.1</a> defines
that a client is allowed to make a search on the root DSE (a search with an
empty bind dn) to find out server properties such as allowed authentication
mechanisms. Such requests are made with the <code>(objectClass=*)</code> filter, which is
the same as found on the above logs.</p>

  </div>
  


</article>

    </main>
    <footer>
    <footer>
  <a href="http://mildred.fr/"> &copy; 2021 Mildred&#39;s Website </a>
</footer>

    <script type="text/javascript"
        src="/comments-static.js"></script>

    </footer>
  </body>
</html>

